<!DOCTYPE html><html>
 <head>
  <meta charset="utf-8">
  </meta>
  <title>
   Chethiya's blog
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </meta>
  <meta name="apple-mobile-web-app-capable" content="yes">
  </meta>
  <link href="http://fonts.googleapis.com/css?family=Raleway:400,100,200,300,500,600,700,800,900" rel="stylesheet" type="text/css">
  </link>
  <link href="lib/skeleton/css/skeleton.css" rel="stylesheet">
  </link>
  <link href="lib/highlightjs/styles/default.css" rel="stylesheet">
  </link>
  <link href="css/style.css" rel="stylesheet">
  </link>
  <link href="css/paginate.css" rel="stylesheet">
  </link>
  <link href="blog.css" rel="stylesheet">
  </link>
  <script>
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-63286859-1', 'auto');
          ga('send', 'pageview');

  </script>
 </head>
 <body>
  <div class="container wallapatta-container ">
   <div class="header ">
    <h1>
     <a href="index.html">
      CHETHIYA ABEYSINGHE
     </a>
    </h1>
    <a class="button " href="https://www.twitter.com/chethiyaa">
     @chethiyaa
    </a>
   </div>
   <div class="wallapatta ">
    <h1 class="title ">
     <a href="wallapatta.html">
      Git based blogging powered by Wallapatta
     </a>
    </h1>
    <h3 class="date ">
     May 22, 2015
    </h3>
    <div class="row ">
     <div class="wallapatta-main nine columns ">
      <div id="wallapatta_0" class="article"><div id="wallapatta_1" class="section"><h3 class="heading"><span id="wallapatta_2" class="block"><span id="wallapatta_13" class="text">Moving to a git based blog powered by Wallapatta</span></span></h3><div class="content"></div></div><div id="wallapatta_3" class="section"><div class="content"><p id="wallapatta_4" class="paragraph"><span id="wallapatta_14" class="text">For long time I wanted to move my blog from </span><a id="wallapatta_15" class="link" href="http://chethiya3000.blogspot.com">blogspot</a><span id="wallapatta_16" class="text"> to a git based blog. Since </span><a id="wallapatta_17" class="link" href="http://twitter.com/vpj">@vpj</a><span id="wallapatta_18" class="text"> has created some </span><a id="wallapatta_19" class="link" href="http://vpj.github.io/wallapatta.html">boilerplates</a><span id="wallapatta_20" class="text">  based on </span><a id="wallapatta_21" class="link" href="http://vpj.github.io/wallapatta/introduction.html">Wallapatta</a><span id="wallapatta_22" class="text"> I thought this is good time to do that.</span></p></div></div><div id="wallapatta_8" class="section"><div class="content"><p id="wallapatta_9" class="paragraph"><span id="wallapatta_24" class="text">Wallapatta is a </span><a id="wallapatta_25" class="link" href="http://en.wikipedia.org/wiki/Markdown">Markdown</a><span id="wallapatta_26" class="text"> like syntax that can create documents with layouts inspired by handouts of Edward R. Tufte</span><sup id="wallapatta_27" class="superScript"><span id="wallapatta_28" class="text">1</span></sup><span id="wallapatta_29" class="text">. We created it to use for documents. The two great things about Wallapatta is that it creates documents with </span><strong id="wallapatta_30" class="bold"><span id="wallapatta_31" class="text">sidenotes</span></strong><span id="wallapatta_32" class="text"> and </span><strong id="wallapatta_33" class="bold"><span id="wallapatta_34" class="text">create print frindly documents</span></strong><span id="wallapatta_35" class="text"> - </span><a id="wallapatta_36" class="link" href="http://vpj.github.io/wallapatta/introduction.html">Wallapatta editor</a><span id="wallapatta_37" class="text"> creates print layouts with intelligent page breaks by trying not to place breaks at middle of content like most word processing software do.</span></p></div></div></div>
     </div>
     <div class="wallapatta-sidebar three columns ">
      <div id="wallapatta_5" class="sidenote"><div id="wallapatta_6" class="section"><div class="content"><p id="wallapatta_7" class="paragraph"><span id="wallapatta_23" class="text">Wallapatta is a tree in Sri Lanka.</span></p></div></div></div><div id="wallapatta_10" class="sidenote"><div id="wallapatta_11" class="section"><div class="content"><p id="wallapatta_12" class="paragraph"><sup id="wallapatta_38" class="superScript"><span id="wallapatta_39" class="text">1</span></sup><span id="wallapatta_40" class="text"> </span><a id="wallapatta_41" class="link" href="http://www.edwardtufte.com/bboard/q-and-a-fetch-msg?msg_id=0000hB">Book design: advice and examples - edwardtufte.com</a></p></div></div></div>
     </div>
     <div style="display:none;">
      <div class='wallapatta-code'>### Moving to a git based blog powered by Wallapatta

For long time I wanted to move my blog from <<http://chethiya3000.blogspot.com(blogspot)>> to a git based blog. Since <<http://twitter.com/vpj(@vpj)>> has created some <<http://vpj.github.io/wallapatta.html(boilerplates)>>  based on <<http://vpj.github.io/wallapatta/introduction.html(Wallapatta)>> I thought this is good time to do that. 

>>>
 Wallapatta is a tree in Sri Lanka.

Wallapatta is a
<<http://en.wikipedia.org/wiki/Markdown(Markdown)>> like syntax that can create documents with layouts
inspired by handouts of Edward R. Tufte^^1^^. We created it to use for documents. The two great things about Wallapatta is that it creates documents with **sidenotes** and **create print frindly documents** - <<http://vpj.github.io/wallapatta/introduction.html(Wallapatta editor)>> creates print layouts with intelligent page breaks by trying not to place breaks at middle of content like most word processing software do.

 >>>
  
  ^^1^^ <<http://www.edwardtufte.com/bboard/q-and-a-fetch-msg?msg_id=0000hB
  (Book design: advice and examples - edwardtufte.com)>>

</div>
     </div>
    </div>
   </div>
   <div class="wallapatta ">
    <h1 class="title ">
     <a href="lds.html">
      LargeDS: Typed Arrays based Data Strcutures for memory intesive tasks
     </a>
    </h1>
    <h3 class="date ">
     July 07, 2015
    </h3>
    <div class="row ">
     <div class="wallapatta-main nine columns ">
      <div id="wallapatta_10000" class="article"><div id="wallapatta_10001" class="section"><h3 class="heading"><span id="wallapatta_10002" class="block"><span id="wallapatta_10111" class="text">The Problem</span></span></h3><div class="content"><div id="wallapatta_10003" class="section"><div class="content"><p id="wallapatta_10004" class="paragraph"><span id="wallapatta_10112" class="text">I use CoffeeScript (Node.js) extensively to analyze large data sets. Time to time I run out of available memory provided by v8 for JS Objects and Arrays. Even in 64-bit Node.js (as of version 0.12) there is ~1.5GB memory limit. But this memory limit does not apply for Types Arrays. I don't believe this is case where we need to look for another resort like C, specially given the flexibility offered by JavaScript.</span></p></div></div></div></div><div id="wallapatta_10008" class="section"><h3 class="heading"><span id="wallapatta_10009" class="block"><span id="wallapatta_10114" class="text">What is LDS</span></span></h3><div class="content"><div id="wallapatta_10010" class="section"><div class="content"><p id="wallapatta_10011" class="paragraph"><a id="wallapatta_10115" class="link" href="https://github.com/chethiya/lds">LDS</a><span id="wallapatta_10116" class="text"> (Large Data Structures) is a library that implements some of basic data structure based on JavaScript Typed Arrays to overcome this memory limit issue. It's still not fine tuned to gain the best performance but very much usable. There can be considerable performance hit in when it comes to strings since the lack of support from JS API to convert between JS String and Buffers</span></p></div></div><div id="wallapatta_10015" class="section"><div class="content"><p id="wallapatta_10016" class="paragraph"><span id="wallapatta_10119" class="text">Here's how to use LDS to implement </span><code id="wallapatta_10120" class="code"><span id="wallapatta_10121" class="text">&lt;string,number&gt;</span></code><span id="wallapatta_10122" class="text"> map in Coffescript.</span></p></div></div><pre id="wallapatta_10020" class="codeBlock"><code class="coffeescript">LDS = <span class="hljs-built_in">require</span> <span class="hljs-string">'lds'</span>
n = <span class="hljs-number">10000000</span>
map = LDS.HashtableBase n, LDS.Types.Int32
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..n]
 map.set <span class="hljs-string">"<span class="hljs-subst">#{i}</span>"</span>, i
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>.<span class="hljs-number">10</span>]
 <span class="hljs-built_in">console</span>.log <span class="hljs-string">"<span class="hljs-subst">#{i}</span> -&gt; <span class="hljs-subst">#{map.get <span class="hljs-string">"<span class="hljs-subst">#{i}</span>"</span>}</span>"</span></code></pre></div></div><div id="wallapatta_10021" class="section"><h3 class="heading"><span id="wallapatta_10022" class="block"><span id="wallapatta_10124" class="text">How to get it</span></span></h3><div class="content"><div id="wallapatta_10023" class="section"><h4 class="heading"><span id="wallapatta_10024" class="block"><span id="wallapatta_10125" class="text">Node.js</span></span></h4><div class="content"><pre id="wallapatta_10025" class="codeBlock"><code class="nohighlight">npm install lds</code></pre><div id="wallapatta_10026" class="section"><div class="content"><p id="wallapatta_10027" class="paragraph"><span id="wallapatta_10126" class="text">And require it as follows</span></p></div></div><pre id="wallapatta_10028" class="codeBlock"><code class="javascript">LDS = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lds'</span>)</code></pre></div></div><div id="wallapatta_10029" class="section"><h4 class="heading"><span id="wallapatta_10030" class="block"><span id="wallapatta_10127" class="text">Browser</span></span></h4><div class="content"><pre id="wallapatta_10031" class="codeBlock"><code class="html"><span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"https://github.com/chethiya/lds/blob/master/build/lds.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span></code></pre><div id="wallapatta_10032" class="section"><div class="content"><p id="wallapatta_10033" class="paragraph"><span id="wallapatta_10128" class="text">And consume it as follows</span></p></div></div><pre id="wallapatta_10034" class="codeBlock"><code class="javascript">LDS = <span class="hljs-built_in">window</span>.LDS</code></pre></div></div></div></div><div id="wallapatta_10035" class="section"><h3 class="heading"><span id="wallapatta_10036" class="block"><span id="wallapatta_10129" class="text">Struct</span></span></h3><div class="content"><div id="wallapatta_10037" class="section"><div class="content"><p id="wallapatta_10038" class="paragraph"><span id="wallapatta_10130" class="text">To represent related values, LDS has an implementation of Struct. A struct definition contains a list of root level property names and the types. Supported types are:</span></p></div></div><pre id="wallapatta_10039" class="codeBlock"><code class="nohighlight">UInt8
UInt32
UInt16
Float32
Float64
String</code></pre><div id="wallapatta_10043" class="section"><div class="content"><p id="wallapatta_10044" class="paragraph"><span id="wallapatta_10132" class="text">Here's an example definition of Struct</span></p></div></div><pre id="wallapatta_10045" class="codeBlock"><code class="coffeescript">Person = LDS.Struct <span class="hljs-string">"Person"</span>,
 {<span class="hljs-attribute">property</span>: <span class="hljs-string">'name'</span>, <span class="hljs-attribute">type</span>: LDS.Types.String, <span class="hljs-attribute">length</span>: <span class="hljs-number">1</span>}
 {<span class="hljs-attribute">property</span>: <span class="hljs-string">'age'</span>, <span class="hljs-attribute">type</span>: LDS.Types.Int16}
 {<span class="hljs-attribute">property</span>: <span class="hljs-string">'values'</span>, <span class="hljs-attribute">type</span>: LDS.Types.Int32, <span class="hljs-attribute">length</span>: <span class="hljs-number">5</span>}
 {<span class="hljs-attribute">property</span>: <span class="hljs-string">'address'</span>, <span class="hljs-attribute">type</span>: LDS.Types.String, <span class="hljs-attribute">length</span>: <span class="hljs-number">5</span>}</code></pre><ul id="wallapatta_10046" class="list"><li id="wallapatta_10047" class="list-item"><span id="wallapatta_10048" class="block"><span id="wallapatta_10133" class="text">property 'name' is a String</span></span></li><li id="wallapatta_10049" class="list-item"><span id="wallapatta_10050" class="block"><span id="wallapatta_10134" class="text">property 'age' is a 16-bit integer</span></span></li><li id="wallapatta_10051" class="list-item"><span id="wallapatta_10052" class="block"><span id="wallapatta_10135" class="text">property 'values' is a fixed-length array of 32-bit integer</span></span></li><li id="wallapatta_10053" class="list-item"><span id="wallapatta_10054" class="block"><span id="wallapatta_10136" class="text">property 'address' is a fixed-length array of Strings</span></span></li></ul><pre id="wallapatta_10055" class="codeBlock"><code class="coffeescript">p = <span class="hljs-keyword">new</span> Person
p.setName <span class="hljs-string">'Bob'</span>
p.setAge <span class="hljs-number">23</span>
p.setValues [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]</code></pre><pre id="wallapatta_10059" class="codeBlock"><code class="coffeescript">p.setAddress [<span class="hljs-string">"No. 123"</span>, <span class="hljs-string">"Street 1"</span>, <span class="hljs-string">"Street 2"</span>, <span class="hljs-string">""</span>]
p.setAddress <span class="hljs-string">"index-3-new"</span>, <span class="hljs-number">3</span></code></pre><pre id="wallapatta_10063" class="codeBlock"><code class="coffeescript">str = <span class="hljs-keyword">new</span> LDS.String <span class="hljs-string">"4-fourth"</span>
p.setAddress str, <span class="hljs-number">4</span>, <span class="hljs-literal">on</span></code></pre><div id="wallapatta_10067" class="section"><div class="content"><p id="wallapatta_10068" class="paragraph"><span id="wallapatta_10153" class="text">Can set LDS.String values instead of JS native Strings by setting the 3rd argument </span><code id="wallapatta_10154" class="code"><span id="wallapatta_10155" class="text">true</span></code><span id="wallapatta_10156" class="text"> in all setter functions</span></p></div></div><pre id="wallapatta_10069" class="codeBlock"><code class="coffeescript">str.release()</code></pre><div id="wallapatta_10070" class="section"><div class="content"><p id="wallapatta_10071" class="paragraph"><span id="wallapatta_10157" class="text">If you are to create LDS.String, you must release those string objects by calling </span><code id="wallapatta_10158" class="code"><span id="wallapatta_10159" class="text">release()</span></code><span id="wallapatta_10160" class="text"> method. In most cases you will not create LDS.Strings. But you might create Hashtables and ArrayLists having LDS.Strings in their Structs. In such cases you'll have to call </span><code id="wallapatta_10161" class="code"><span id="wallapatta_10162" class="text">release()</span></code><span id="wallapatta_10163" class="text"> method of those objects once you are done working with that data structure.</span></p></div></div><pre id="wallapatta_10072" class="codeBlock"><code class="coffeescript"><span class="hljs-built_in">console</span>.log p.get()</code></pre><pre id="wallapatta_10076" class="codeBlock"><code class="coffeescript"><span class="hljs-built_in">console</span>.log p.getAddress <span class="hljs-number">2</span></code></pre><pre id="wallapatta_10080" class="codeBlock"><code class="coffeescript">str = p.getAddress <span class="hljs-number">0</span>, <span class="hljs-literal">on</span>

<span class="hljs-built_in">console</span>.log str.toString()
str.release()

p2 = <span class="hljs-keyword">new</span> Person
p2.copyFrom p
<span class="hljs-built_in">console</span>.log p2.get()</code></pre><div id="wallapatta_10084" class="section"><div class="content"><p id="wallapatta_10085" class="paragraph"><code id="wallapatta_10173" class="code"><span id="wallapatta_10174" class="text">Struct.copyFrom()</span></code><span id="wallapatta_10175" class="text"> method copies the content from source struct buffer area to target struct buffer area. LDS.Strings are copied by reference.</span></p><ul id="wallapatta_10086" class="list"><li id="wallapatta_10087" class="list-item"><span id="wallapatta_10088" class="block"><span id="wallapatta_10176" class="text">Reference counts to existing strings in source are decremented by 1.</span></span></li><li id="wallapatta_10089" class="list-item"><span id="wallapatta_10090" class="block"><span id="wallapatta_10177" class="text">Reference counts to strings in target are incremented by 1.</span></span></li></ul></div></div></div></div><div id="wallapatta_10091" class="section"><h3 class="heading"><span id="wallapatta_10092" class="block"><span id="wallapatta_10178" class="text">Array List</span></span></h3><div class="content"><div id="wallapatta_10093" class="section"><div class="content"><p id="wallapatta_10094" class="paragraph"><span id="wallapatta_10179" class="text">There is an implementation of LDS.Array. But LDS.Array hits a 32-bit limitation as size in </span><code id="wallapatta_10180" class="code"><span id="wallapatta_10181" class="text">new ArrayBuffer size</span></code><span id="wallapatta_10182" class="text"> has to be somewhere around </span><code id="wallapatta_10183" class="code"><span id="wallapatta_10184" class="text">2^30</span></code><span id="wallapatta_10185" class="text"> at max. Therefore LDS.Array has a maximum size limit of </span><code id="wallapatta_10186" class="code"><span id="wallapatta_10187" class="text">2^29 / (#bytes_per_strcut)</span></code></p></div></div><div id="wallapatta_10095" class="section"><div class="content"><p id="wallapatta_10096" class="paragraph"><span id="wallapatta_10188" class="text">ArrayList is build on top of LDS.Array and it is a list of LDS.Arrays. Therefore it has a size limit much greater than </span><code id="wallapatta_10189" class="code"><span id="wallapatta_10190" class="text">2^32</span></code><span id="wallapatta_10191" class="text">.</span></p></div></div><div id="wallapatta_10097" class="section"><div class="content"><p id="wallapatta_10098" class="paragraph"><span id="wallapatta_10192" class="text">Here's hoe to make a large LDS.ArrayList using the </span><code id="wallapatta_10193" class="code"><span id="wallapatta_10194" class="text">sturct Person</span></code><span id="wallapatta_10195" class="text">.</span></p></div></div><pre id="wallapatta_10099" class="codeBlock"><code class="coffeescript"><span class="hljs-function"><span class="hljs-title">testArratList</span> = <span class="hljs-params">(n)</span> -&gt;</span>
 arr = <span class="hljs-keyword">new</span> Array <span class="hljs-number">5</span>
 people = <span class="hljs-keyword">new</span> LDS.ArrayList Person
 instanece = <span class="hljs-literal">null</span>
 <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..n]
  instance = people.add instance <span class="hljs-comment"># same as people.add()</span>
  instance.copyFrom p2
  instance.setName <span class="hljs-string">"<span class="hljs-subst">#{i}</span>"</span>

  <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-number">5</span>]
   arr[j] = <span class="hljs-string">"<span class="hljs-subst">#{i}</span>-<span class="hljs-subst">#{j}</span>"</span> <span class="hljs-comment"># or instance.setAddress "#{i}-#{j}", j</span>
  instance.setAddress arr
 <span class="hljs-built_in">console</span>.log <span class="hljs-string">'Done pushing elements'</span>
 <span class="hljs-built_in">console</span>.log <span class="hljs-string">'Reading from ArrayList'</span>
 <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-number">10</span>]
  p = (Math.floor Math.random()*n) % n
  <span class="hljs-comment">#following is equal to (people.get p).getAddress()</span>
  <span class="hljs-built_in">console</span>.log p, (people.get p, instance).getAddress()</code></pre></div></div><div id="wallapatta_10103" class="section"><h3 class="heading"><span id="wallapatta_10104" class="block"><span id="wallapatta_10209" class="text">Hash Table</span></span></h3><div class="content"></div></div><div id="wallapatta_10105" class="section"><div class="content"><p id="wallapatta_10106" class="paragraph"><span id="wallapatta_10210" class="text">LDS.HastableBase is a </span><code id="wallapatta_10211" class="code"><span id="wallapatta_10212" class="text">&lt;string,number&gt;</span></code><span id="wallapatta_10213" class="text"> implementation. LDS.Hashtable is a more generic </span><code id="wallapatta_10214" class="code"><span id="wallapatta_10215" class="text">&lt;string,LDS.Struct&gt;</span></code><span id="wallapatta_10216" class="text"> hashtable that is based on LDS.HashtableBase.</span></p></div></div><pre id="wallapatta_10107" class="codeBlock"><code class="coffeescript"><span class="hljs-function"><span class="hljs-title">testHashtable</span> = <span class="hljs-params">(n)</span> -&gt;</span>
 <span class="hljs-built_in">console</span>.time <span class="hljs-string">'time_hashtable'</span>
 arr = <span class="hljs-keyword">new</span> Array <span class="hljs-number">5</span>
 people = LDS.Hashtable n, Person <span class="hljs-comment">#creates a hashtable of size n</span>
 instance = <span class="hljs-literal">null</span>
 <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..n]
  instance = people.get <span class="hljs-string">"<span class="hljs-subst">#{i}</span>"</span>, instance <span class="hljs-comment">#gets the value in key #{i}</span>
  instance.copyFrom p2

  <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-number">5</span>]
   instance.setAddress <span class="hljs-string">"<span class="hljs-subst">#{i}</span>-<span class="hljs-subst">#{j}</span>"</span>, j
 <span class="hljs-built_in">console</span>.timeEnd <span class="hljs-string">'time_hashtable'</span>
 <span class="hljs-built_in">console</span>.log <span class="hljs-string">'Done populating the hastable'</span>
 <span class="hljs-built_in">console</span>.log <span class="hljs-string">'Reading from hashtable'</span>

 <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-number">20</span>]
  p = (Math.floor Math.random()*n*<span class="hljs-number">2</span>) % (<span class="hljs-number">2</span>*n)
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> people.check <span class="hljs-string">"<span class="hljs-subst">#{p}</span>"</span> <span class="hljs-comment">#checks whether key exists</span>
   <span class="hljs-built_in">console</span>.log p, <span class="hljs-literal">null</span>
  <span class="hljs-keyword">else</span>
   <span class="hljs-built_in">console</span>.log p, (people.get <span class="hljs-string">"<span class="hljs-subst">#{p}</span>"</span>, instance).getAddress()</code></pre></div>
     </div>
     <div class="wallapatta-sidebar three columns ">
      <div id="wallapatta_10005" class="sidenote"><div id="wallapatta_10006" class="section"><div class="content"><p id="wallapatta_10007" class="paragraph"><a id="wallapatta_10113" class="link" href="http://coffeescript.org/">"CoffeeScript is a little language that compiles into JavaScript."</a></p></div></div></div><div id="wallapatta_10012" class="sidenote"><div id="wallapatta_10013" class="section"><div class="content"><p id="wallapatta_10014" class="paragraph"><span id="wallapatta_10117" class="text">You can get LDS from here: </span><a id="wallapatta_10118" class="link" href="https://github.com/chethiya/lds">https://github.com/chethiya/lds</a></p></div></div></div><div id="wallapatta_10017" class="sidenote"><div id="wallapatta_10018" class="section"><div class="content"><p id="wallapatta_10019" class="paragraph"><span id="wallapatta_10123" class="text">At the moment LDS only supports String keys</span></p></div></div></div><div id="wallapatta_10040" class="sidenote"><div id="wallapatta_10041" class="section"><div class="content"><p id="wallapatta_10042" class="paragraph"><span id="wallapatta_10131" class="text">LDS has it's own implementation of String. It uses 2-byte fixed with character encoding so that there is always one-to-one transformation between JS native String and LDS.String</span></p></div></div></div><div id="wallapatta_10056" class="sidenote"><div id="wallapatta_10057" class="section"><div class="content"><p id="wallapatta_10058" class="paragraph"><span id="wallapatta_10137" class="text">Only firs 3 values of </span><code id="wallapatta_10138" class="code"><span id="wallapatta_10139" class="text">values</span></code><span id="wallapatta_10140" class="text"> will be set</span></p></div></div></div><div id="wallapatta_10060" class="sidenote"><div id="wallapatta_10061" class="section"><div class="content"><p id="wallapatta_10062" class="paragraph"><span id="wallapatta_10141" class="text">4th element in </span><code id="wallapatta_10142" class="code"><span id="wallapatta_10143" class="text">address</span></code><span id="wallapatta_10144" class="text"> array is changed to a new value </span><code id="wallapatta_10145" class="code"><span id="wallapatta_10146" class="text">index-3-new</span></code></p></div></div></div><div id="wallapatta_10064" class="sidenote"><div id="wallapatta_10065" class="section"><div class="content"><p id="wallapatta_10066" class="paragraph"><span id="wallapatta_10147" class="text">Sets the 5th element of </span><code id="wallapatta_10148" class="code"><span id="wallapatta_10149" class="text">address</span></code><span id="wallapatta_10150" class="text"> to LDS.string </span><code id="wallapatta_10151" class="code"><span id="wallapatta_10152" class="text">str</span></code></p></div></div></div><div id="wallapatta_10073" class="sidenote"><div id="wallapatta_10074" class="section"><div class="content"><p id="wallapatta_10075" class="paragraph"><span id="wallapatta_10164" class="text">LDS.StructClass.get() method returns a JSON object of the struct instance.</span></p></div></div></div><div id="wallapatta_10077" class="sidenote"><div id="wallapatta_10078" class="section"><div class="content"><p id="wallapatta_10079" class="paragraph"><span id="wallapatta_10165" class="text">If a property in a Struct is an array, then the 1st argument of getters will be  the index of the respective array.</span></p></div></div></div><div id="wallapatta_10081" class="sidenote"><div id="wallapatta_10082" class="section"><div class="content"><p id="wallapatta_10083" class="paragraph"><span id="wallapatta_10166" class="text">2nd argument of getters is the </span><code id="wallapatta_10167" class="code"><span id="wallapatta_10168" class="text">`string_flag</span></code><span id="wallapatta_10169" class="text">` that indicates the return value is a LDS.String object. You'll have to </span><code id="wallapatta_10170" class="code"><span id="wallapatta_10171" class="text">release()</span></code><span id="wallapatta_10172" class="text"> those objects after consuming.</span></p></div></div></div><div id="wallapatta_10100" class="sidenote"><div id="wallapatta_10101" class="section"><div class="content"><p id="wallapatta_10102" class="paragraph"><span id="wallapatta_10196" class="text">An object of the struct is passed in to </span><code id="wallapatta_10197" class="code"><span id="wallapatta_10198" class="text">add()</span></code><span id="wallapatta_10199" class="text"> and </span><code id="wallapatta_10200" class="code"><span id="wallapatta_10201" class="text">get()</span></code><span id="wallapatta_10202" class="text"> methods so that those methods can resume passed in </span><code id="wallapatta_10203" class="code"><span id="wallapatta_10204" class="text">Object</span></code><span id="wallapatta_10205" class="text"> rather than creating new one. If such an object is not passed in as an argument the methods will create a new </span><code id="wallapatta_10206" class="code"><span id="wallapatta_10207" class="text">Object</span></code><span id="wallapatta_10208" class="text">.</span></p></div></div></div><div id="wallapatta_10108" class="sidenote"><div id="wallapatta_10109" class="section"><div class="content"><p id="wallapatta_10110" class="paragraph"><code id="wallapatta_10217" class="code"><span id="wallapatta_10218" class="text">get(key)</span></code><span id="wallapatta_10219" class="text"> method returns LDS.Struct instance of the given </span><code id="wallapatta_10220" class="code"><span id="wallapatta_10221" class="text">key</span></code><span id="wallapatta_10222" class="text">. If </span><code id="wallapatta_10223" class="code"><span id="wallapatta_10224" class="text">key</span></code><span id="wallapatta_10225" class="text"> doesn't exists in the hash table, it creates a new key-value pair and returns the created instance.</span></p></div></div></div>
     </div>
     <div style="display:none;">
      <div class='wallapatta-code'>### The Problem

 I use CoffeeScript (Node.js) extensively to analyze large data sets. Time to time I run out of available memory provided by v8 for JS Objects and Arrays.
 >>>
  <<http://coffeescript.org/("CoffeeScript is a little language that compiles into JavaScript.")>>
 Even in 64-bit Node.js (as of version 0.12) there is ~1.5GB memory limit. But this memory limit does not apply for Types Arrays. I don't believe this is case where we need to look for another resort like C, specially given the flexibility offered by JavaScript.

### What is LDS

 <<https://github.com/chethiya/lds(LDS)>> (Large Data Structures) is a library that implements some of basic data structure based on JavaScript Typed Arrays to overcome this memory limit issue.
 >>>
  You can get LDS from here:
  <<https://github.com/chethiya/lds>>

 It's still not fine tuned to gain the best performance but very much usable. There can be considerable performance hit in when it comes to strings since the lack of support from JS API to convert between JS String and Buffers

 Here's how to use LDS to implement ``<string,number>`` map in Coffescript.

 >>>
  At the moment LDS only supports String keys

 ```coffeescript
  LDS = require 'lds'
  n = 10000000
  map = LDS.HashtableBase n, LDS.Types.Int32
  for i in [0...n]
   map.set "#{i}", i
  for i in [0..10]
   console.log "#{i} -> #{map.get "#{i}"}"

### How to get it
 #### Node.js
  ```
   npm install lds

  And require it as follows

  ```javascript
   LDS = require('lds')

 #### Browser
  ```html
   <script src="https://github.com/chethiya/lds/blob/master/build/lds.js"></script>

  And consume it as follows

  ```javascript
   LDS = window.LDS

###Struct

 To represent related values, LDS has an implementation of Struct. A struct definition contains a list of root level property names and the types. Supported types are:

 ```
  UInt8
  UInt32
  UInt16
  Float32
  Float64
  String

 >>>
  LDS has it's own implementation of String. It uses 2-byte fixed with character encoding so that there is always one-to-one transformation between JS native String and LDS.String

 Here's an example definition of Struct

 ```coffeescript
  Person = LDS.Struct "Person",
   {property: 'name', type: LDS.Types.String, length: 1}
   {property: 'age', type: LDS.Types.Int16}
   {property: 'values', type: LDS.Types.Int32, length: 5}
   {property: 'address', type: LDS.Types.String, length: 5}

 * property 'name' is a String
 * property 'age' is a 16-bit integer
 * property 'values' is a fixed-length array of 32-bit integer
 * property 'address' is a fixed-length array of Strings

 ```coffeescript
  p = new Person
  p.setName 'Bob'
  p.setAge 23
  p.setValues [1, 2, 3]

 >>>
  Only firs 3 values of ``values`` will be set


 ```coffeescript
  p.setAddress ["No. 123", "Street 1", "Street 2", ""]
  p.setAddress "index-3-new", 3

 >>>
  4th element in ``address`` array is changed to a new value ``index-3-new``

 ```coffeescript
  str = new LDS.String "4-fourth"
  p.setAddress str, 4, on

 >>>
  Sets the 5th element of ``address`` to LDS.string ``str``

 Can set LDS.String values instead of JS native Strings by setting the 3rd argument ``true`` in all setter functions


 ```coffeescript
  str.release()


 If you are to create LDS.String, you must release those string objects by calling ``release()`` method. In most cases you will not create LDS.Strings. But you might create Hashtables and ArrayLists having LDS.Strings in their Structs. In such cases you'll have to call ``release()`` method of those objects once you are done working with that data structure.


 ```coffeescript
  console.log p.get()

 >>>
  LDS.StructClass.get() method returns a JSON object of the struct instance.

 ```coffeescript
  console.log p.getAddress 2

 >>>
  If a property in a Struct is an array, then the 1st argument of getters will be  the index of the respective array.

 ```coffeescript
  str = p.getAddress 0, on

  console.log str.toString()
  str.release()

  p2 = new Person
  p2.copyFrom p
  console.log p2.get()

 >>>
  2nd argument of getters is the ```string_flag``` that indicates the return value is a LDS.String object. You'll have to ``release()`` those objects after consuming.

 ``Struct.copyFrom()`` method copies the content from source struct buffer area to target struct buffer area. LDS.Strings are copied by reference.

  * Reference counts to existing strings in source are decremented by 1.

  * Reference counts to strings in target are incremented by 1.


###Array List

 There is an implementation of LDS.Array. But LDS.Array hits a 32-bit limitation as size in ``new ArrayBuffer size`` has to be somewhere around ``2^30`` at max. Therefore LDS.Array has a maximum size limit of ``2^29 / (#bytes_per_strcut)``

 ArrayList is build on top of LDS.Array and it is a list of LDS.Arrays. Therefore it has a size limit much greater than ``2^32``.

 Here's hoe to make a large LDS.ArrayList using the ``sturct Person``.

 ```coffeescript
  testArratList = (n) ->
   arr = new Array 5
   people = new LDS.ArrayList Person
   instanece = null
   for i in [0...n]
    instance = people.add instance # same as people.add()
    instance.copyFrom p2
    instance.setName "#{i}"

    for j in [0...5]
     arr[j] = "#{i}-#{j}" # or instance.setAddress "#{i}-#{j}", j
    instance.setAddress arr
   console.log 'Done pushing elements'
   console.log 'Reading from ArrayList'
   for i in [0...10]
    p = (Math.floor Math.random()*n) % n
    #following is equal to (people.get p).getAddress()
    console.log p, (people.get p, instance).getAddress()

 >>>
  An object of the struct is passed in to ``add()`` and ``get()`` methods so that those methods can resume passed in ``Object`` rather than creating new one. If such an object is not passed in as an argument the methods will create a new ``Object``.

###Hash Table

LDS.HastableBase is a ``<string,number>`` implementation. LDS.Hashtable is a more generic ``<string,LDS.Struct>`` hashtable that is based on LDS.HashtableBase.

```coffeescript
 testHashtable = (n) ->
  console.time 'time_hashtable'
  arr = new Array 5
  people = LDS.Hashtable n, Person #creates a hashtable of size n
  instance = null
  for i in [0...n]
   instance = people.get "#{i}", instance #gets the value in key #{i}
   instance.copyFrom p2

   for j in [0...5]
    instance.setAddress "#{i}-#{j}", j
  console.timeEnd 'time_hashtable'
  console.log 'Done populating the hastable'
  console.log 'Reading from hashtable'

  for i in [0...20]
   p = (Math.floor Math.random()*n*2) % (2*n)
   if not people.check "#{p}" #checks whether key exists
    console.log p, null
   else
    console.log p, (people.get "#{p}", instance).getAddress()

>>>
 ``get(key)`` method returns LDS.Struct instance of the given ``key``. If ``key`` doesn't exists in the hash table, it creates a new key-value pair and returns the created instance.

</div>
     </div>
    </div>
   </div>
  </div>
  <script src="lib/highlightjs/highlight.pack.js">
  </script>
  <script src="lib/weya/weya.js">
  </script>
  <script src="lib/weya/base.js">
  </script>
  <script src="lib/mod/mod.js">
  </script>
  <script src="js/static.js?v=9">
  </script>
  <script src="js/parser.js?v=9">
  </script>
  <script src="js/reader.js?v=9">
  </script>
  <script src="js/nodes.js?v=9">
  </script>
  <script src="js/render.js?v=9">
  </script>
 </body>
</html>
